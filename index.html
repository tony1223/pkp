<html>
<head>
  <meta charset="UTF-8" />
  <title>柯P政策你來批</title>
  <meta content="柯P政策你來批" property="og:title">
  <meta content="柯P政策你來批" property="og:site_name">
  <meta content="http://jiten.go-kanken.com/kanjib/972.gif" property="og:image">
  <meta content="康聖人連聲誇獎說：文章奇哉，文章妙哉，文章奇妙而絕哉！" property="og:description">
  <meta content="website" property="og:type">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <style>
    .hide {
      display: none;
    }
    #content {
      margin: 0 auto;
      margin-top: 80px;
      max-width: 1200px;
    }
    .conversation-wrap {
      box-shadow: -2px 0 3px #ddd;
      padding:0;
      max-height: 400px;
      overflow: auto;
    }
    .conversation {
      padding:5px;
      border-bottom:1px solid #ddd;
      margin:0;
    }
    .message-wrap {
      box-shadow: 0 0 3px #ddd;
      padding:0;
    }
    .msg {
      padding:10px 5px;
      border-bottom:1px solid #ddd;
      margin:0;
    }
    .msg-wrap {
      padding:10px;
      max-height: 400px;
      overflow: auto;
    }
    .time {
      color:#bfbfbf;
    }
    .send-wrap {
      margin-bottom: 10px;
    }
    .send-message {
      resize: none;
    }
    .highlight {
      background-color: #f7f7f9;
      border: 1px solid #e1e1e8;
    }
    .send-message-btn {
      border-top-left-radius: 0;
      border-top-right-radius: 0;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }
    .media-heading {
      color:#003bb3;
      font-weight: 700;
      padding-bottom: 8px;
    }
    .msg-date {
      background: none;
      text-align: center;
      color:#aaa;
      border:none;
      box-shadow: none;
      border-bottom: 1px solid #ddd;
    }
    .col-lg-10 {
      padding: 0;
    }
  </style>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53886292-10', 'auto');
    ga('send', 'pageview');

  </script>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">柯P政策你來批</a>
    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span id="navTitle">選擇你要批的政策</span> <span class="caret"></span></a>
          <ul id="topNav" class="dropdown-menu" role="menu">
            <li><a href="#">政策讀取中...</a></li>
          </ul>
        </li>
      </ul>
      <form class="navbar-form navbar-right hide">
        <button type="button" class="btn btn-default">市民登入</button>
      </form>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://kptaipei.tw" target="_blank">柯文哲官方網站</a></li>
        <li><a href="http://unlimited.kptaipei.tw" target="_blank">野生官網</a></li>

        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">更多應用 <span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li><a target="_blank" href="https://unlimited-kp.appspot.com/">MA柯P</a></li>
            <li><a target="_blank" href="http://lab.andretw.com/kp/">柯P挑戰</a></li>
            <li><a target="_blank" href="http://kpgotyo.herokuapp.com">KP Got Yo!  KP嘎油!</a></li>
            <li><a target="_blank" href="http://goooooooogle.github.io/kp/">柯 P 滑出來對你說政見 Plugin</a></li>
            <li><a target="_blank" href="http://kp-policy-speech.herokuapp.com/">柯P政策導讀</a></li>
            <li><a target="_blank" href="http://brianhsu.moe/KPWild/">柯文哲野生官網 BrianHsu.moe 分站</a></li>
            <li><a target="_blank" href="http://minipai.github.io/kp-reader/">柯P新政閱讀器</a></li>
            <li><a target="_blank" href="http://kp-is-everywhere.github.io/">柯文哲關鍵字小幫手</a></li>
            <li class="divider"></li>
            <li><a target="_blank" href="https://www.facebook.com/groups/unlimited.kptaipei.tw/">柯文哲 API 使用討論區</a></li>
          </ul>
        </li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
<div id="content" class="row">
  <div id="main" class="col-md-7" style="border-right:1px solid #ccc"></div>
  <div id="comments" class="col-md-5">
    <div id="commentBox">
      <h3>留下評語</h3>
      <div class="row">
        <div class="col-sm-6">
          <div class="form-group">
            <input type="text" class="form-control" id="yourname" placeholder="您的姓名">
          </div>
        </div>
        <div class="col-sm-6">
          <select class="form-control" id="identity">
            <option value="">--- 身分選擇 ---</option>
            <option value="0">天龍人</option>
            <option value="1">邊陲地區人民</option>
            <option value="2">鄉下人</option>
            <option value="3">非人物種</option>
            <option value="4">高級外省人</option>
            <option value="5">昴宿星人</option>
            <option value="6">路人甲</option>
            <option value="7">黨工</option>
            <option value="8">網軍</option>
            <option value="9">NPC</option>
          </select>
        </div>
      </div>
      <div class="send-wrap">
        <textarea id="message" class="form-control send-message" rows="3" placeholder="請留下您對於此則政見的評語"></textarea>
      </div>
      <div class="form-group">
        <label>您對這則政見的評價是：</label>
        <div class="btn-group">
          <button type="button" class="btn btn-default vote" value="0">爛政見</button>
          <button type="button" class="btn btn-default vote" value="1">不妥</button>
          <button type="button" class="btn btn-default vote active" value="2">已讀</button>
          <button type="button" class="btn btn-default vote" value="3">適妥</button>
          <button type="button" class="btn btn-default vote" value="4">好政見</button>
        </div>
      </div>
        <button type="submit" class="btn btn-info btn-block" id="submit">留下評語</button>
    </div>
    <hr>
    <div id="commentList">資料讀取中...</div>
  </div>
</div>
<input type="hidden" id="articleID" value="">
<input type="hidden" id="voteStar" value="2">
<script src="//code.jquery.com/jquery-1.11.1.min.js" type="text/javascript"></script>
<script src='https://cdn.firebase.com/js/client/1.0.17/firebase.js'></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script>
<script>
var api = 'kp53f568e77303e9.28212837',
    database = new Firebase('https://p-kp.firebaseio.com');
$(function(){
  loadArticle(api,3233,database);
  loadNav(api);
  $('#topNav').on('click','.navItem',function(e){
    e.stopPropagation();
    e.preventDefault();
    var id = $(this).find('input').val();
    loadArticle(api,id,database);
    $('#topNav').parent().removeClass('open');
  });
  $('.vote').click(function(){
    var val = $(this).val();
    $('.vote').removeClass('active');
    $(this).addClass('active');
    $('#voteStar').val(val);
  });
  $('#submit').click(function(){
    var target = $('#articleID').val();
    writeComment(database,target);
  });
});
function loadArticle(apiKey,targetID,database){
  $.get('http://api.kptaipei.tw/v1/category/40?accessToken='+apiKey,function(result){
    $.each(result.data,function(ind,item){
      if(item.id==targetID) {
        var article = '<h1>'+item.title+'</h1><p>'+item.content+'</p>';
        $('#main').html(article);
        $('#articleID').val(item.id);
        //$('#navTitle').text(item.title);
        readComment(database,item.id);
      }
    });
  });
}
function loadNav(apiKey){
  var menu='';
  $.get('http://api.kptaipei.tw/v1/category/40?accessToken='+apiKey,function(result){
    $.each(result.data,function(ind,item){
      menu = '<li><a href="#" class="navItem"><span>'+item.title+'</span><input type="hidden" value="'+item.id+'"></a></li>'+menu;
    });
    $('#topNav').html('').append(menu);
  });
}
function readComment(database,target) {
  var vote = ['爛政見','不妥','已讀','適妥','好政見'];
  var identity = ['天龍人','邊陲地區人民','鄉下人','非人物種','高級外省人','昴宿星人','路人甲','黨工','網軍','NPC'];
  database.child(target).on('value',function(response) {
    $('#commentList').html('');
    if(response.val()==null) $('#commentList').html('尚無評論');
    $.each(response.val(),function(ind,item){
      $.each(item,function(ind,comment){
        var data = '<div class="media msg"><a class="pull-left"><img class="media-object" src="http://www.ie.edu/university/img/ie-way-profile-default.gif" style="width:48px; height:48px;"></a><div class="media-body"><small class="pull-right time"><i class="fa fa-clock-o"></i> '+(new Date(comment.time)).toString().substr(0,21)+' &nbsp; <span class="badge">'+vote[comment.vote]+'</span></small><h5 class="media-heading">'+comment.name+' ('+identity[comment.identity]+')</h5><small class="col-lg-10">'+comment.message+'</small></div></div>';
        $('#commentList').prepend(data);
      });
    });
  });
}
function writeComment(database,target) {
  var time = new Date().getTime(),
      name = $('#yourname').val(),
      identity = $('#identity').val(),
      message = $('#message').val(),
      vote = $('#voteStar').val();
  database.child(target).child('message'+time).push({
    name: name,
    identity: identity,
    message: message,
    time: time,
    vote: vote
  });
}
</script>
</body>
</html>
